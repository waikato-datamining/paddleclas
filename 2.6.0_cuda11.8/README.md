# PaddleClas

Uses [PaddleClas](https://github.com/PaddlePaddle/PaddleClas) ([documentation](https://github.com/PaddlePaddle/PaddleClas/blob/release/2.6/README_en.md)). 

Uses PyTorch 2.5.1, CUDA 11.8 and PaddleClas 2.6.0.

## Quick start

### Inhouse registry

* Log into registry using *public* credentials:

  ```bash
  docker login -u public -p public public.aml-repo.cms.waikato.ac.nz:443 
  ```

* Pull and run image (adjust volume mappings `-v`):

  ```bash
  docker run --gpus=all --shm-size 8G --net=host \
    -v /local/dir:/container/dir \
    -it public.aml-repo.cms.waikato.ac.nz:443/paddle/paddleclas:2.6.0_cuda11.8
  ```

### Docker hub

* Pull and run image (adjust volume mappings `-v`):

  ```bash
  docker run --gpus=all --shm-size 8G --net=host \
    -v /local/dir:/container/dir \
    -it waikatodatamining/paddleclas:2.6.0_cuda11.8
  ```

### Build local image

* Build the image from Docker file (from within /path_to/paddleclas/2.6.0_cuda11.8)

  ```bash
  docker build -t paddleclas .
  ```
  
* Run the container

  ```bash
  docker run --gpus=all --shm-size 8G --net=host -v /local/dir:/container/dir -it paddleclas
  ```
  `/local/dir:/container/dir` maps a local disk directory into a directory inside the container


## Publish images

### Build

```bash
docker build -t paddleclas:2.6.0_cuda11.8 .
```

### Inhouse registry  

* Tag

  ```bash
  docker tag \
    paddleclas:2.6.0_cuda11.8 \
    public-push.aml-repo.cms.waikato.ac.nz:443/paddle/paddleclas:2.6.0_cuda11.8
  ```
  
* Push

  ```bash
  docker push public-push.aml-repo.cms.waikato.ac.nz:443/paddle/paddleclas:2.6.0_cuda11.8
  ```
  If error "no basic auth credentials" occurs, then run (enter username/password when prompted):
  
  ```bash
  docker login public-push.aml-repo.cms.waikato.ac.nz:443
  ```

### Docker hub  

* Tag

  ```bash
  docker tag \
    paddleclas:2.6.0_cuda11.8 \
    waikatodatamining/paddleclas:2.6.0_cuda11.8
  ```
  
* Push

  ```bash
  docker push waikatodatamining/paddleclas:2.6.0_cuda11.8
  ```
  If error "no basic auth credentials" occurs, then run (enter username/password when prompted):
  
  ```bash
  docker login
  ``` 


### Requirements

```bash
docker run --rm --pull=always \
  -it public.aml-repo.cms.waikato.ac.nz:443/paddle/paddleclas:2.6.0_cuda11.8 \
  pip freeze > requirements.txt
```

**NB:** Ensure that any CUDA preamble has been removed before committing.


## Permissions

When running the docker container as regular use, you will want to set the correct
user and group on the files generated by the container (aka the user:group launching
the container):

```bash
docker run -u $(id -u):$(id -g) -e USER=$USER ...
```

## Caching

PaddleClas will download pretrained models and cache them locally. To avoid having
to download them constantly, you can the cache directory to the host machine:

* when running the container as current user

  ```bash
  -v `pwd`/cache:/.paddleclas \
  -v `pwd`/cache/visualdl:/.visualdl \
  ```


## Scripts

The following additional scripts are available:

* `paddleclas_export_config` - for exporting template config files and setting parameters (located in `/opt/PaddleClas/ppcls/configs`; calls the `/opt/PaddleClas/tools/export_config.py` script)
* `paddleclas_train` - for training models (calls the `/opt/PaddleClas/tools/train.py` script)
* `paddleclas_predict_poll` - for generating predictions of supplied files in batch/poll mode (calls the `/opt/PaddleClas/tools/predict_poll.py` script)
* `paddleclas_predict_redis` - for generating predictions via Redis (calls the `/opt/PaddleClas/tools/predict_redis.py` script)


### paddleclas_export_config

Examples of setting additional parameters (`-a/--additional`):

* `Infer.PostProcess.topk:3`
* `Metric.Train.[0].TopkAcc.topk:2,6`

For lists, you can use `[X]` with X being the 0-based index. Otherwise, the
name of the YAML value is used. Value lists use commas to separate their values. 
int/float/str/list types are supported.


## Troubleshooting

* `train_mode: progressive` - does not seem to exist and generates the following
  error message: `UnboundLocalError: cannot access local variable 'cur_magnitude' where it is not associated with a value`.
  Simply comment out that parameter or use the `-r/--remove` option to remove  
  the parameter during export.

* `The number of input's channels should be equal to filter's channels` - dimension mismatch

  If you get an error like this at inference time:
  ```
  ppcls ERROR: Exception occurred when processing image #0 with msg: (InvalidArgument) The number of input's channels should be equal to filter's channels * groups for Op(Conv). But received: the input's channels is 384, the input's shape is [1, 384, 384, 3]; the filter's channels is 3, the filter's shape is [24, 3, 3, 3]; the groups is 1, the data_format is NCHW. The error may come from wrong data_format setting.
  [Hint: Expected input_channels == filter_dims[1] * groups, but received input_channels:384 != filter_dims[1] * groups:3.] (at /paddle/paddle/phi/infermeta/binary.cc:563)
  ```
  
  Then you may be missing the `- ToCHWImage:` entry under `Infer`/`transforms` which 
  rearranges the tensor from `nhwc` to `nchw`.
